<script>
  // Инициализация объекта Web App. Если не в Telegram, tg будет null.
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  // DOM элементы (оставляем без изменений)
  const mainPage = document.getElementById('mainPage');
  const registrationModal = document.getElementById('registrationModal');
  const mainRegisterBtn = document.getElementById('mainRegisterBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const submitBtn = document.getElementById('submitBtn');

  const firstName = document.getElementById('firstName');
  const lastName = document.getElementById('lastName');
  const email = document.getElementById('email');
  const phone = document.getElementById('phone');

  // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
  // (оставляем без изменений)
  function isValidEmail(e) { /* ... */ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
  function isValidPhone(p) { /* ... */ return /\+?\d{7,15}/.test(p.replace(/\s|[-()]/g, "").replace(/^8/, '+7')); }
  function clearErrors() { /* ... */ }
  function validate() { /* ... */ }
  function gatherData() {
    return {
      firstName: firstName.value.trim(),
      lastName: lastName.value.trim(),
      email: email.value.trim(),
      phone: phone.value.trim()
    };
  }
  // === КОНЕЦ ВСПОМОГАТЕЛЬНЫХ ФУНКЦИЙ ===

  // Открыть модаль и предзаполнить поля
  mainRegisterBtn.addEventListener('click', () => {
    mainPage.style.display = 'none';
    registrationModal.classList.add('show');
    
    // ЛОГИКА ПРЕДЗАПОЛНЕНИЯ (работает только если tg не null)
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      const user = tg.initDataUnsafe.user;
      
      firstName.value = user.first_name || '';
      lastName.value = user.last_name || '';
      
      // E-mail доступен, только если вы запросили его в боте
      if (user.email) { email.value = user.email; }
    }

    // Фокусировка на первом незаполненном поле
    if (!firstName.value) {
      firstName.focus();
    } else if (!lastName.value) {
      lastName.focus();
    } else if (!email.value) {
      email.focus();
    } else {
      phone.focus();
    }
    
    // Безопасное скрытие кнопки Telegram
    if (tg) { tg.MainButton.hide(); }
  });

  // Закрыть модаль (полная очистка)
  closeModalBtn.addEventListener('click', () => {
    registrationModal.classList.remove('show');
    mainPage.style.display = 'flex';
    
    clearErrors();
    firstName.value = '';
    lastName.value = '';
    email.value = '';
    phone.value = '';

    // Безопасное скрытие кнопки Telegram
    if (tg) { tg.MainButton.hide(); }
  });

  // Отправить данные (самый важный блок)
  submitBtn.addEventListener('click', () => {
    if (!validate()) return;

    const payload = gatherData();

    if (tg) {
      // ✅ РАБОТАЕТ В ТЕЛЕГРАМ: отправляем JSON вашему Python-боту
      tg.sendData(JSON.stringify(payload));
      try { tg.close(); } catch(e) {}
    } else {
      // ❌ РАБОТАЕТ В БРАУЗЕРЕ: показываем alert вместо отправки боту
      alert("Режим отладки. Данные для отправки:\n" + JSON.stringify(payload, null, 2));
      closeModalBtn.click(); 
    }
  });

  // Инициализация Telegram Web App
  // Безопасно вызываем расширение только если tg существует
  if (tg) {
    try { tg.expand(); } catch (e) {}
  }
</script>
