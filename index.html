<script>
    // Инициализация объекта Web App. Если не в Telegram, tg будет null.
    // ЭТОТ БЛОК ПРЕДОТВРАЩАЕТ 210 ОШИБОК В БРАУЗЕРЕ
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  
    // DOM элементы
    const mainPage = document.getElementById('mainPage');
    const registrationModal = document.getElementById('registrationModal');
    const mainRegisterBtn = document.getElementById('mainRegisterBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const submitBtn = document.getElementById('submitBtn');
  
    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const email = document.getElementById('email');
    const phone = document.getElementById('phone');
  
    // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
  
    function isValidEmail(e) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
    }
  
    function isValidPhone(p) {
      return /\+?\d{7,15}/.test(p.replace(/\s|[-()]/g, "").replace(/^8/, '+7')); 
    }
  
    function clearErrors() {
      document.getElementById('errorFirstName').classList.remove('show');
      document.getElementById('errorLastName').classList.remove('show');
      document.getElementById('errorEmail').classList.remove('show');
      document.getElementById('errorPhone').classList.remove('show');
    }
  
    function validate() {
      clearErrors();
      let isValid = true;
  
      if (!firstName.value.trim()) {
        document.getElementById('errorFirstName').textContent = "Укажите имя";
        document.getElementById('errorFirstName').classList.add('show');
        isValid = false;
      }
  
      if (!lastName.value.trim()) {
        document.getElementById('errorLastName').textContent = "Укажите фамилию";
        document.getElementById('errorLastName').classList.add('show');
        isValid = false;
      }
  
      if (!isValidEmail(email.value.trim())) {
        document.getElementById('errorEmail').textContent = "Некорректный e‑mail";
        document.getElementById('errorEmail').classList.add('show');
        isValid = false;
      }
  
      if (!isValidPhone(phone.value.trim())) {
        document.getElementById('errorPhone').textContent = "Некорректный телефон";
        document.getElementById('errorPhone').classList.add('show');
        isValid = false;
      }
  
      return isValid;
    }
  
    function gatherData() {
      // Собираем основные данные
      let data = {
        firstName: firstName.value.trim(),
        lastName: lastName.value.trim(),
        email: email.value.trim(),
        phone: phone.value.trim()
      };
  
      // Добавляем данные Telegram, если они доступны
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        data.telegram_user_id = tg.initDataUnsafe.user.id;
        data.username = tg.initDataUnsafe.user.username || null;
      }
  
      return data;
    }
  
    // === ОБРАБОТЧИКИ СОБЫТИЙ ===
  
    // Открыть модаль и ПРЕДЗАПОЛНИТЬ поля
    mainRegisterBtn.addEventListener('click', () => {
      mainPage.style.display = 'none';
      registrationModal.classList.add('show');
      
      // Логика автоматического заполнения (только если tg не null)
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        
        firstName.value = user.first_name || '';
        lastName.value = user.last_name || '';
        if (user.email) { email.value = user.email; }
      }
  
      // Фокусировка
      if (!firstName.value) { firstName.focus(); } 
      else if (!lastName.value) { lastName.focus(); } 
      else if (!email.value) { email.focus(); } 
      else { phone.focus(); }
      
      // Безопасное скрытие кнопки Telegram (только если tg не null)
      if (tg) { tg.MainButton.hide(); }
    });
  
    // Закрыть модаль (полная очистка)
    closeModalBtn.addEventListener('click', () => {
      registrationModal.classList.remove('show');
      mainPage.style.display = 'flex';
      
      clearErrors();
      firstName.value = '';
      lastName.value = '';
      email.value = '';
      phone.value = '';
  
      // Безопасное скрытие кнопки Telegram (только если tg не null)
      if (tg) { tg.MainButton.hide(); }
    });
  
    // Отправить данные 
    submitBtn.addEventListener('click', () => {
      if (!validate()) return;
  
      const payload = gatherData();
  
      if (tg) {
        // ✅ РАБОТАЕТ В ТЕЛЕГРАМ: отправляем JSON вашему Python-боту
        tg.sendData(JSON.stringify(payload));
        try { tg.close(); } catch(e) {}
      } else {
        // ❌ РАБОТАЕТ В БРАУЗЕРЕ: показываем alert, чтобы имитировать отправку
        console.log("Данные для отправки:", payload);
        alert("Режим отладки. Данные собраны, но не отправлены в ТГ-бот.");
        closeModalBtn.click(); 
      }
    });
  
    // Инициализация Telegram Web App
    // Безопасно вызываем расширение только если tg существует
    if (tg) {
      try { tg.expand(); } catch (e) {}
    }
  </script>
